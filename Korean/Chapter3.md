# Chapter 3 

## 3-1 Consensys

네 이전 강좌들을 통해 기존 블록체인 플랫폼들의 문제점을 다루어 보았는데요. 클레이튼 블록체인이 어떤 합의 알고리즘을 사용하여 문제점들을 해결하는 지에 대해서 이야기해보겠습니다. 합의 알고리즘의 종류는 여러가지가 있는데 보통 퍼블릭 블록체인에서 많이 사용하는 POW 나 POS , 그리고 프라이빗 블록체인에서 사용하는 PBFT 나 Raft 가 있습니다. 보통 프라이빗 블록체인이 퍼블릭 블록체인보다 더 효율적으로 합의에 도달할 수 있는데 특히 BFT 기반의 프라이빗 블록체인은 참여 노드의 수를 제한하여 높은 성능과 효율성을 달성할 수가 있습니다. 그러나 이러한 구성은 합의 노드수를 제한하며, 분산화를 약화시키고 합의 결과에 대한 내용이 소규모 그룹에게만 공개되기 때문에 투명성이 저하되고 블록체인 혜택을 의미있게 사용하지 못합니다. 

자 반면에 클레이튼은 BFT 의 성능 이점을 살려서 퍼블릭 블록체인의 장점과 결합할 수 있다는 믿음을 토대로 IBFT 를 합의 알고리즘으로 선택합니다. 강력한 보안 및 투명성을 유지하면서 엔터프라이즈급 성능 및 안정성을 제공하는 퍼블릭 블록체인이 지향하고 있고요. 이러한 목표를 달성하기 위해서 클레이튼은 공개를 통한 개인적인 합의 신뢰 모델을 채택하고 있습니다. 즉 합의를 달성하는 소수의 프라이빗한 노드들과 바깥에서 블록생성 결과를 공개적으로 접근 및 검증 할 수 있는 노드들로 구성되어있습니다. 네 이제 클레이튼에서 합의 알고리즘으로 사용하는 이스탄불 BFT 가 무엇인지 더 알아보도록 하겠습니다. 네 이스탄불 BFT 에서는 크게 세단계의 합의 과정에 있습니다. 프리프리페어, 프리페어, 그리고 커밋단계가 있는데요, 라운드 로빈 방식을 선택해서 매 라운드 마다 합의 노드들 중에 프로포절을 뽑습니다. 제안자라는 뜻이 있죠. 그리고 나머지 합의 노드들은 밸리데이터가 되요. 검증을 하게 되구요. 그림을 보시면 프로포저, 벨리데이터 1 2 3 이 다같은 합의 노드들이고요. 이중에 엑스표시가 되어있는 밸리데이터 3 노드가 현재 falt 한 상태. 즉 검증자로써 작동을 못하는 상태입니다. 컴퓨터가 고장났거나 네트워크가 끊어졋거나 또는 악의적으로 행동할 때를 말하구요. 네 첫번째 단계가 프로포즈라는 단계인데 이 단계에서 합의의 노드들 중에 한 노드가 프로포저 로 선택이 됩니다. 그리고 두번째 프리 프리페어 단게에서 프로포저 노드가 블록을 만들어서 다른 노드들에게 제안을 하게 되요. 자 여기보시면 밸리데이터 1 노드한테 보내고 2 노드한테 보내고 3 노드한테 보내죠. 이번에는 내가 제안하는 차례 이면서 이렇게 메세지와 함께 전달하는 단계입니다. 세번째 프리페어 단계에서 검증자 노드들이 벨리데이터 1 2 3 노드들이 프로포저한테 메세지를 받으면 자신을 제외한 다른 노드들에게 잘 받았다 라는 메세지를 보냅니다. 그래서 여기 보시면 밸리데이터 1 노드도 세군데에다가 보내고요, 밸리데이터 2 노드도 세군데에다가 보냅니다. 자 잘받았어 하면서 보내는 겁니다. 하지만 밸리데이터 3노드는 현재 falt 가 난 상태이기 때문에 아무것도 안보내고 계속 받기만 하는 상태이구요. 프리페어 상태가 이렇게 끝나면 시스템에서 총 몇개의 노드가 살아 있구나 하는 걸 알 수가 있어요. 이미지 같은 경우에는 프로포저 벨리데이터 1 벨리데이터 2 노드 해서 총 3개의 노드가 살아있다는 것을 알 수가 있죠. 이 과정을 검증자들이 모두 같은 라운드에 있는지 확인하는 겁니다. 마지막으로 커밋단게에서는 프로포저한테 보낸 블록을 수락할건지 다른 노드들과 소통하면서 결정하는 과정인데요. 예를 들어서 프로포저한테서 받은 블록이 괜찮다고 생각하는지 아니면 잘못되었다고 생각하는지 이렇게 각자 응답을 보냅니다. 만약 2/3이상이 합의를 했다고 계산하면 블록승인을 하고 곧바로 넘어가게 되는거구요. 결국에는 이 커밋단계에서 결정이 되고 파이널리티가 정리가 됩니다. 즉 파이널리티의 부재가 없고 변경불가능한 최종적인 상태가 이 스테이지에서 마무리가 되요. 비트코인이나 이더리움의 POW 처럼 애매모호한 상태가 아니라는 거죠. 자 그래서 장점은 합의 노드들끼리 통신을 통해 합의를 이끌어내고 그 즉시 완결성을 가집니다. 

하지만 그 합의 노드가 많아지면 많아질 수록 그만큼 통신량이 기하급수적으로 늘어난다는 단점도 있는데 이 부분은 합의 노드의 일부만 뽑아서 BFT  형태로 유지하게 설정되어있습니다. 

다음 강좌에서 좀 더 자세히 블록이 어떤 방식으로 생성되고 전파되는지 알아보도록 하겠습니다.
