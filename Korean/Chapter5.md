# 5. 클레이튼 덧셈 게임 프론트엔드 개발

## 5.1 설정

앞선 강좌들을 통해 bApp에 쓰일 컨트랙트를 만들었으니까요 이제 프론트엔드 개발을 해보겠습니다.
먼저 기본적인 환경설정을 진행하도록 할건데 이 강좌에서는 node.js, npm, truffle 프레임워크 그리고 비쥬얼 스튜디오 코드를 다운받아 보겠습니다. 
node.js는 서버사이드 자바스크립트 플랫폼인데 우리가 만들 BApp에서 꼭 필요합니다.
npm은 node.js 설치하면 같이 설치되는데요 개발하면서 툴이나 라이브러리를 다운받기 위해 꼭 필요한 존재이구요.
우리가 설치할 truffle 프레임워크도 이 npm을 통해서 다운받아야 합니다.
혹시 이미 node.js와 npm이 설치 되어 있으면 버전을 확인하시고 node.js가 버전 8 이상이고 npm이 버전 5 이상이면 이 부분 스킵하셔도 됩니다.

nodejs.org로 오셔서 오늘 강좌 촬영 기준으로 10.15.3 LTS가 최신 버전이구요. 
자 이거 클릭하셔서 다운 받으시면 됩니다.
다운 다 받으면 설치해주시구요.
저는 이미 설치가 다 되어서 이 부분 스킵하도록 하겠습니다.

설치 끝나셨으면 파워셸에서 node.js가 잘 설치되었는지 확인해 볼 건데요.
자 파워셸을 키겠습니다.
네 파워셀에서 node -v 치시고 버전 확인 하시구요
npm도 확인해 보겠습니다. npm -v
네 그러면 npm도 설치가 잘 되었죠.

마지막으로 truffle을 설치해 볼건데요 truffle은 bApp을 쉽게 개발할 수 있도록 도와주는 프레임워크입니다.
스마트 계약을 컴파일하고 테스트하며 배포도 할 수 있게 해주죠.
아주 많이 쓰고 있는 대중화된 프레임워크입니다.
최근에 트러플 버전이 5로 업데이트 되었구요.
하지만 클레이튼이 버전 4에 맞춰져서 개발이 됬기 때문에 일단은 truffle 버전 4에 맞춰서 진행하겠습니다.
버전 4 이하거나 5가 이미 설치되어 있다면 먼저 지우도록 하겠습니다.
파워셸에서 npm uninstall -g truffle 치셔서 지우시면 되구요.
자 그리고 이제 npm install -g truffle@4.1.15 치셔서 자 버전 4를 받겠습니다.
네 다 받으시면 truffle version 커맨드를 통해 버전을 확인하시구요.
네 그러면 4.1.15 버전이고 밑에 솔리디티는 이 컴파일러는 0.4.25 버전이라고 합니다.
솔리디티는 스마트 계약을 작성할 수 있는 프로그래밍 언어이구요.

네 마지막으로 최고의 코드 에디터인 비쥬얼 스튜디오 코드를 다운받아 보겠습니다.
code.visualstudio.com으로 오셔서 여기에 Download for Windows 클릭하시고요.
저는 이것도 미리 다운 받아서 스킵하겠습니다.
다운 다 받으시면 설치하고 실행시켜 주시구요.

비주얼스튜디오 코드는 크로스 플랫폼이 지원되서 리눅스, 윈도우즈, 맥에서 다 돌아가고 디버깅 지원과 깃 제어, 구문 강조 기능 등 여러가지 편리한 기능들이 포함되어 있습니다.
네 비쥬얼 스튜디오 코드에서 여기 확장탭 클릭해 주시구요.
여기에서 솔리디티 언어 서포트 되는 익스텐션 하나 설치해보도록 하겠습니다.
여기다가 solidity 치시고 맨 위에꺼 선택해 주세요.
설치 클릭합니다.
이 익스텐션은 솔리디티 문법마다 강조되는 색깔을 제공하고 또 컴파일도 할 수 있게 해줍니다.
네 설치가 완료 되었구요 여기까지의 프론트엔드 개발에 필요한 환경 설정을 끝내도록 하겠습니다.

## 5.2 기본 템플릿(boilerplate) 다운로드

개발을 위한 보일러 플레이트 즉 기본 템플릿을 다운받아 보겠습니다.
클레이튼 비앱이 트러플 프레임워크에서 개발될 수 있다고 했었죠.
트러플에서 비앱 개발에 필요한 표준 템플릿들을 다운 받을 수 있게 해준 곳이 있습니다.
트러플 박스라고 하는데요
이곳으로 오시면은 여러가지 종류들을 볼 수 있습니다.
예를 들어, 앵귤러나 리액트를 사용해서 비앱개발 하고 싶으면 거기에 맞춰진 템플릿을 다운받으시면 됩니다.
자 여기 보시면은 리액트도 있구요 또 앵귤러 사용하시는 분들은 또 앵귤러 템플릿 다운받으시면 됩니다.
하지만 여기에서 다운받는 템플릿들은 이더리움 디앱에 특화됬기 때문에 다운받으시고 안에 있는 이더리움 부분들을 지우셔야 합니다.
그리고 클레이튼에 맞게 설정하셔야 하구요.
그닥 어려운 부분은 아니지만 제가 여기서 미리 웹팩이라는 템플릿을 다운받고 우리 강좌에 맞게 클레이튼 식으로 바꿨습니다.
그리고 여러분들이 다운받으실 수 있도록 깃허브에 올려놓았구요.
참고로 저희는 공평성을 위해 자바스크립트 네이티브와 제이쿼리로 진행하겠습니다.
처음 접하셨더라도 쉽게 따라하실 수 있구요.
파워셸을 여시고 다운받고 싶은 위치에서 git clone https://github.com/kkagill/addition-game-starter.git 커맨드를 실행합니다. 
그러면 다운받구요.
네 다운로드 받았구요 해당 경로로 들어가겠습니다.
cd addition-game-starter
네 이제 code .을 쳐서 구조를 보도록 하겠습니다.
이게 비쥬얼 스튜디오 코드로 여는거 구요.
자 먼저 위에서부터 차근차근 확인하도록 하죠.
이 컨트랙트 폴더에는 솔리디티 컨트랙트 파일들을 보관하는 곳이구요.
우리가 만들었던 AdditionGame 컨트랙트가 미리 추가가 되어 있구요.
그리고 아래 Migrations라는 컨트랙트가 있는데 이게 스마트 계약을 배포할 때 아래에 있는 migrations폴더 안에 있는 이 스크립트 파일들을 지금 하나지만 나중에는 하나더 생길거에요.
그파일들을 실행하게 합니다.
그래서 이 Migrations 파일이 정말 중요해요 배포하는데 꼭 필요한 파일이니까 절대 지우시면 안되구요
그다음에 migration 폴더 안에 있는 스크립트 파일, 이 파일에는 배포하는 과정에 쓰이는 로직이 담겨 잇습니다.
이 파일 보시면 마이그레션스 컨트랙트 파일을 불러와서 그내용을 클레이튼 노드에 디플로이 즉 배포를 하죠, 그런 역할이구요.
이제 소스 폴더 안에는 비앱의 프론트엔드를 담당하는 구조를 설정했습니다.
index.html파일은 앞에 보여주는 뷰를 담당할 거 구요.
여기 보시면 비앱에 쓰일 제이쿼리나 부트스트랩을 cdn으로 불러오고 그리고 맨 아래에는 css 부분을 미리 추가해 놓았습니다.
별로 중요하지 않은 파트라서 미리 추가 했구요.
index.js 파일은 기능들을 실행하기 위한 엔진과 같은 파일입니다.
우리가 앞으로 쓰게 될 함수들 이름들만 이렇게 미리 정의해 놓았구요.
맨 아래에 있는 이 옵션 opts 변수는 로딩할 때 스피너 보여주는 환경 설정 변수입니다.
이것도 중요한 부분이 아니라서 미리 추가를 했구요.
package.json은 npm을 통해 필요한 디팬던시를 추가한 곳 입니다.
중요하게 보셔야 할 것이 caver.js, 즉 클레이튼 블록체인과 소통하게 해주는 라이브러리 파일들을 다운 받은 거구요 ethereum의 web3.js비슷한 존재 이죠
truffle.js는 환경 설정을 담당하는데요 어느 네트워크에 스마트계약을 배포할지 여기다가 정의를 하는 겁니다. 
다음 강좌에서 내용들을 추가하도록 하구요
마지막으로 이 webpack.config.js 파일은 파일들을 최적화 시켜주고 또 코드의 변화가 있을 때마다 감지를 해서 브라우저에 변경사항을 새로고침 할 필요없이 반영해 주는 역할을 합니다.
여기까지 클레이튼 덧셈 비앱을 만듥기 위한 스타터 템플릿을 다운 받고 구조도 설명해 드렸습니다.

## 5.3 바오밥 테스트넷에 스마트 컨트랙트 배포하기 1

지금부터 바오밥 테스트넷에 우리가 만든 AdditionGame 스마트 계약을 배포해보도록 하겠습니다.
시작하기 전에 터미널에서 npm install 커맨드를 실행하고 비앱에 필요한 디펜던시를 설치하겠습니다.
아래 터미널  안보이시는 분들은 위의 터미널 탭에서 새 터미널을 선택하시면 되구요.
이제 npm install 커맨드를 실행시킵니다.
살짝 시간이 걸리고요 끝나면 node_modules라는 폴더가 생기면서 디펜던시 설치가 완료됩니다. 
이거 끝나고 다시 돌아오도록 하겠습니다.
네 설치가 완료되었습니다.
먼저 마이그레이션즈 폴더안에 새로운 파일 하나 만들어 보죠
여기서 오른쪽 클릭하시고 새 파일 선택합니다.
이름은 2_deploy_contracts.js라고 하시면 되구요.
네 여기에다가 AdditionGame 컨트랙트를 노드에 배포하는 로직을 추가할 겁니다.
그러면 1_initial_migration.js 파일로 가셔서 이거 코드 다 복사하세요.
컨트롤 c 누르시ㅣ고 다시 이쪽 온 다음에 붙여넣기 하겠습니다.
위에 Migrations.sol 이거 AdditionGame.sol로 바꿔 주시고요.
이제 AdditionGame 컨트랙트를 가져온다고 변경을 하는거죠.
자 이름도 바꿔 주시고 아래의 디플로이 여기 받는 인자도 AddtionGame으로 바꿔 줍니다.
여기까지 하면 간단하게 배포하는 기본적인 로직은 끝났어요.
하지만 배포하는 과정에서 얻을 수 있는 몇가지 정보들을 비앱내에 어떤 파일들에다가 저장하는 코드를 작성할 겁니다.
나중에 그 정보 가지고 컨트랙트 인스턴스 만드는데 아주 유용하게 쓸 수 있구요.
자 그래서 여기 아래다가 deployer가 AdditionGame 컨트랙트를 deploy하고 나서 then을 통해 Promise로 json 데이터를 받습니다. 
자 then
그리고 이 안에다가

if (AdditionGame._json) {

AdditionGame의 json 데이터를 받았다면 파일 시스템 모듈을 통해 파일에다가 저장할 겁니다.
그러기 위해서는 import 시켜야 되구요. 
맨 위에다가 const fs = require('fs') 파일 시스템을 추가합니다.
자 그리고 두개의 파일을 만들거에요.
abi와 컨트랙트 주소를 저장할 수 있는 곳인데요.
여기 밖에다가 오른쪽 클릭하시고 새 파일 선택합니다.
이름은 deployedABI라고 하구요 또하나 만드셔서 이름은 deployedAddress 주소죠 라고 하시구요.
이제 파일 시스템을 써서 각각의 파일들에다가 저장을 하겠습니다.
먼저 abi의 정보를 저장하는 코드를 만들어보죠
abi는 블록체인과 컨트랙트 간의 상호작용을 할 수 있는 내용입니다.
자 다시 여기로 가셔서 if 안에 다가 

fs.writeFile(
    	'deployedABI',
    	JSON.stringify(AdditionGame._json.abi),
 
설명하죠
파일시스템 안에 writeFile 함수가 있는데 두가지를 넘기죠.
첫번째는 어떤 파일에다가 이거를 쓸건지 정의를 해 주고 두번째로는 json 파일, json으로 받은 abi의 정보를 스트링화 시켜서 이렇게 인자로 넘기는 겁니다.
마지막으로 에러처리 하겠습니다.
에러가 났을 때는 throw를 해라 아니면 콘솔에다가 성공했다고 메세지를 쓰죠.

(err) => {
    if (err) throw err
    console.log("파일에 ABI 입력 성공");
})

에러가 있으면 throw 하고 없으면 콘솔에다가 로그를 찍겠습니다.
이렇게 하면 이 deployedABI 파일에 배포된 컨트랙트의 abi 정보가 문자화 되어서 저장이 되는 거고요.

계속해서 배포된 컨트랙트 주소도 파일에다가 저장하겠습니다.
여기 아래에다가

fs.writeFile(
  	'deployedAddress',
  	AdditionGame.address,
  	(err) => {
    	if (err) throw err
    	console.log("파일에 주소 입력 성공");
	})

이번에는 주소입니다. 그리고 에러처리 하구요. 에러가 나면 자 throw하고 아니면 콘솔을 찍어라. 파일에 주소 입력 성공.

네 여기까지 하면은 매번 배포할 때, 저희가 원하는 정보들을 각 파일에다가 바로 저장할 수 있게 되었습니다. 
계속해서 다음 강좌에서 truffle.js안에다가 환경설정을 하고 배포 하겠습니다.

## 5.4 바오밥 테스트넷에 스마트 컨트랙트 배포하기 2

이제 마지막으로 환경설정을 해야되는데요.
배포를 할 때, 어느 네트워크에다가 할껀지 정의해야합니다.
truffle.js 파일로 가시구요. 여기에다기 이제부터 정의를 하겠습니다.
먼저 connect-privkey-to-provider 라는 라이브러리를 가져오구요.

const PrivateKeyConnector = require('connect-privkey-to-provider')

그리고 network ID라는 상수도 만듭니다.

const NETWORK_ID = '1001'

이 1001은 바오밥 고유의 network ID를 의미하구요.  

const GASLIMIT = '20000000'

배포하는데 들어가는 가스 한도를 이정도 줍니다.
0이 총 7개 이구요.

자 다음으로 

const URL = `https://api.baobab.klaytn.net:8651`

URL은 클레이튼 풀노드가 현재 돌아가고 있는 주소를 대입했습니다.
바오밥 테스트넷이구요.

마지막으로 비밀키를 담는 상수가 필요한데 우리가 예전에 클레이튼 월렛을 통해 생성했던 계정의 비밀키를 가져오겠습니다.
제가 예전 강좌에서 비밀키 다른 곳에 저장하시라고 했었죠.
저는 메모장에 저장했던 것을 복사해서 붙여넣기 하겠습니다.

const PRIVATE_KEY = ''

자 저는 붙여 넣었구요.
이제 이 설정들을 module.exports 안에다가 사용해보겠습니다.
설명을 해 드리도록 하죠.
자 여기 네트워크는 klaytn을 쓴다고 했고요
그리고 이 안에다가 네 가지 옵션들을 명세합니다.
먼저 provider 즉 클레이튼 노드를 제공하는 공급자를 명시하는 건ep
private-key-connector 인스턴스를 생성하고 2개의 인자들을 넘깁니다.
첫번째는 내 계정 비밀 키를 넘기고 두번째는 풀노드가 돌아가고 있는 네트워크 주소를 넘기구요.
이렇게 하면 내 비밀키를 사용해서 바오밥 테스트넷에 연결할 수 있게 되는 겁니다.
그다음으로 네트워크 id,그리고 gas대입하고 마지막으로 gas price 즉 가스 가격은 여기다 null 값을 주는데 이거는 바오밥 네트워크에서 자동적으로 가스 가격을 잡아주기 때문에요 이렇게 null 값을 넘기는 겁니다.
여기까지 스마트 계약을 배포할 수있는 환경 설정을 마쳤구요.
나름 간단했죠. 이제 배포를 해보겠습니다.
아래 터미널에 truffle deploy --network klaytn 자 이거를 실행을 합니다.
자 그러면 클레이튼 네트워크에 배포를 하게 되구요.
배포하는데 조금 시간이 걸리지만 금방 될겁니다.
성공적으로 배포를 했구요.
여기 콘솔로 찍힌 이 성공 문구 표시가 있죠.
제가 예전에 했던거 이렇게 나오면서 이제 deplyedABI 파일 가보시면은 여기에 abi정보가 저장되어 있죠.
그리고 deployedAddress 가 보시면 배포된 컨트랙트의 주소가 이렇게 저장되었습니다.
잘 작동하네요.
마지막으로 배포를 하게되면 이 위에 build라는 폴더가 생성이 되는데요 그안에 contracts폴더가 있고 또 그안에 2개의 json파일들이 있죠.
얘네들 영어로 artifact라고 하는데요.
자 각각의 artifact 파일은 해당 컨트랙트의 abi의 정보와 추가적으로 컨트랙트와 관련된 모든 정보들을 담고 있습니다.
자 여기 abi 우리가 아깐 deployedABI 파일에다가 따로 저장한 내용이에요.
abi는 application binary interface의 약자입니다.
이안에 보시면 우리가 AdditionGame 컨트랙트에서 쓰는 함수들과 변수들이 이렇게 json 형식으로 나타냈습니다.
이게 간단하게 말해서 블록체인의 이 컨트랙트를 배포했을때 그 컨트랙트에 있는 함수들을 호출하고 또 데이터가 내가 예상했던 형식으로 리턴될 수 있도록 보장하는 겁니다.
컨트랙트와 상호 작용할 수 있는 방법을 정의한 곳이에요.
맨 아래쪽으로 내려가 보시면은 엄청 길거든요 쭉 땡겨서 아래로 가보시면
여기에 네트워크 섹션 있죠, 여기 보면은 1001 이거는 클레이튼 고유의 네트워크 id라고 했었죠.
그리고 밑에 있는 address는 이 컨트랙트의 현제 바오밥 테스트넷에 지금 이 주소로 배포가 되어 있다라는 겁니다.
마지막으로 클레이튼 노드의 컨트랙트를 재배포하고 싶을 때, 이 커맨드를 사용하면 됩니다.
예를 들어서 우리가 컨트랙트을 수정해야 되는데 그러면 노드에다가 재배포 해야겠죠
그럴때 truffle deploy -compile-all -reset -network klaytn
여기 -compile-all은 모든 컨트랙트를 재컴파일 시키구요 -reset은 migrations 폴더 안에 있는 스크립트 파일들을 강제적으로 다시 실행시킵니다.
그러면 실행시켜보죠.
실행을 시키면 노드에 컨트랙트를 다시 재배포 하구요.
네 거의 완성이 되면서 성공적으로 마쳤습니다.
자 deployedAddress 파일 열어보시면 주소가 바뀌어 있다는 걸 확인하실 수 있을 거에요.
이렇게 배포를 할 때마다 주소가 계속 바뀌는 겁니다.
여기까지 truffle을 이용해서 컨트랙트를 클레이튼 바오밥 네트워크에 배포해 보았습니다.
 
## 5.5 계정 검증 UI

## 5.6 계정 검증 로직(키스토어 확인)

## 5.7 계정 검증(지갑 통합)

## 5.8 계정 세션

## 5.9 컨트랙트에 클레이 전송하기(입금)

## 5.10 컨트랙트에 클레이 전송하기(UI 변경과 테스트)

## 5.11 무작위 숫자 생성하기

## 5.12 타이머 생성하기

## 5.13 답안 제출하기 및 클레이 받기